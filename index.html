<!DOCTYPE html>
<html>
	<head>
		<style>
			.container { }
			.potentialDestination { background: #ffff00; }
		</style>
		<script src="js/jquery-1.9.0.min.js"></script>
		<script>

			// treeView allows for live edits to the tree. It will also not alter the HTML, nor styling. You have full control.
			$.fn.treeView = function(options) {
				var defaultOptions = {
					draggables : "li",
					acceptDraggableFromElsewhere : false,
					ghosting : true,
					droppables : "ul",
					onDragStart : function(draggedElement) {

					},
					onDragCancelled : function(draggedElement) {

					},
					onDrop : function(draggedElement, destinationElement) {

					},
					onDrag : function(draggedElement) {

					}, 
					// onEnterDroppable on the next droppable is fired *before* the onLeaveDroppable of the previous droppable
					onEnterDroppable : function(draggedElement,  enteredDroppable) {

					},
					onHoverDroppable : function(draggedElement, hoveredDroppable) {

					}, 
					onLeaveDroppable : function(draggedElement, leftDroppable) {

					},
					getGhostingContent : function(draggedElement) {
						return draggedElement;
					}
				};
				options = $.extend(defaultOptions, options);
				var elements = this;

				elements.each(function() {
					var tree = $(this);
					var draggables = tree.find(options.draggables);
					var droppables = tree.find(options.droppables);
					var currentlyDraggedElement = null;
					var currentlyHoveredElement = null;
					var elementWasDroppedSuccessfully = false;

					var randomEventNamespace = ".jQuery-treeView-" + new Date().getTime() + "-" + Math.random();
					tree.data("jquery_treeview_randomeventnamespace", randomEventNamespace);

					draggables.each(function() {
						this.draggable = true;
						$(this).on("dragstart"+randomEventNamespace, function(event) {
							currentlyDraggedElement = $(event.target);
							options.onDragStart(currentlyDraggedElement);
							// Set the ghosting image
							if (!options.ghosting) {
								event.originalEvent.dataTransfer.setDragImage($("<div/>").get(0), 0, 0);
							} else {
								var ghosting = options.getGhostingContent(currentlyDraggedElement);
								if (ghosting instanceof jQuery) {
									ghosting = ghosting.get(0);
								}
								if (ghosting instanceof Element) {
									event.originalEvent.dataTransfer.setDragImage(ghosting, 0, 0);
								}
							}
							event.stopPropagation();
						});
						$(this).on("drag"+randomEventNamespace, function(event) {
							options.onDrag(currentlyDraggedElement);
							event.stopPropagation();
						});
						$(this).on("dragend"+randomEventNamespace, function(event) {
							// Trigger a 'leave' on the currentlyHoveredElement
							if (currentlyHoveredElement) {
								options.onLeaveDroppable(currentlyDraggedElement, currentlyHoveredElement);
							}
							// Trigger a cancel or a drop, based on whether the elementWasDroppedSuccessfully
							if (elementWasDroppedSuccessfully) {
								options.onDrop(currentlyDraggedElement, currentlyHoveredElement);
							} else {
								options.onDragCancelled(currentlyDraggedElement);
							}
							// Reset variables
							currentlyDraggedElement = null;
							currentlyHoveredElement = null;
							elementWasDroppedSuccessfully = false;
							event.preventDefault();
							event.stopPropagation();
						});
					});

					droppables.each(function() {
						$(this).on("dragover"+randomEventNamespace, function(event) {
							// .PreventDefault() is a means of saying that we accept the draggable
							event.preventDefault();
							event.stopPropagation();
							currentlyHoveredElement = $(event.target);
							options.onHoverDroppable(currentlyDraggedElement, currentlyHoveredElement);
						});
						$(this).on("dragenter"+randomEventNamespace, function(event) {
							// .PreventDefault() is a means of saying that we accept the draggable
							event.preventDefault();
							event.stopPropagation();
							currentlyHoveredElement = $(event.originalEvent.currentTarget);
							options.onEnterDroppable(currentlyDraggedElement, currentlyHoveredElement);
						});
						$(this).on("dragleave"+randomEventNamespace, function(event) {
							event.preventDefault();
							event.stopPropagation();
							options.onLeaveDroppable(currentlyDraggedElement, currentlyHoveredElement);
							currentlyHoveredElement = null;
						});
						$(this).on("drop"+randomEventNamespace, function(event) {
							event.preventDefault();
							event.stopPropagation();
							elementWasDroppedSuccessfully = true;
							currentlyHoveredElement = $(event.originalEvent.currentTarget);
							// Actual onDrop event will be thrown at dragEnd
						});
					});
				});

				return {
					stop : function() {
						elements.each(function() {
							var tree = $(this);
							var draggables = tree.find(options.draggables);
							var droppables = tree.find(options.droppables);
							var randomEventNamespace = tree.data("jquery_treeview_randomeventnamespace");
							// Unbind all event-listeners
							draggables.each(function() {
								this.draggable = false;
								$(this).off(randomEventNamespace);
							});
							droppables.each(function() {
								$(this).off(randomEventNamespace);
							});
						})
						
					}
				}
			};

			$(function() {
				function placeAtTarget(elementToPlace, target) {
					target.append(elementToPlace);
				}
				var treeView = $(".container").treeView({
					draggables : "li",
					droppables : "ul",
					onDragStart : function(draggedElement) {
						draggedElement.animate({
							opacity: 0.2
						});
					},
					onDragCancelled : function(draggedElement) {
						$(".container").find(".potentialDestination").remove();
						draggedElement.animate({
							opacity: 1
						});
					},
					onDrop : function(draggedElement, destinationElement) {
						$(".container").find(".potentialDestination").remove();
						draggedElement.animate({
							opacity: 1
						});
						placeAtTarget(draggedElement, destinationElement);
					},
					onDrag : function(draggedElement) {

					}, 
					onEnterDroppable : function(draggedElement,  enteredDroppable) {
						$(".container").find(".potentialDestination").remove();
						placeAtTarget($("<li class='potentialDestination'>&nbsp</li>"), enteredDroppable);
					},
					onHoverDroppable : function(draggedElement, hoveredDroppable) {

					}, 
					onLeaveDroppable : function(draggedElement, leftDroppable) {

					},
					ghosting : true,
					getGhostingContent : function(draggedElement) {
						return draggedElement;
					}
				});
				//treeView.stop();
			});
		</script>
	</head>
	<body>
		<div class='container'>
			<ul class='tree1'>
				<li class='file1'>hai</li>
				<li class='folder'>folder
					<ul>
						<li class='file2'>file</li>
					</ul>
				</li>
			</ul>
			<ul class='tree2'>
				<li class='file1'>hai</li>
				<li class='folder'>folder
					<ul>
						<li class='file2'>file</li>
					</ul>
				</li>
			</ul>
		</div>
		<script>
			// Analytics
		</script>
	</body>
</html>